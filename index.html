<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul class="comments">
    </ul>
    <div class="add-form">
      <input id="name" type="text" class="add-form-name" placeholder="Введите ваше имя" value="" />
      <textarea id="text" type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"
        value=""></textarea>
      <div class="add-form-row">
        <button id="button" class="add-form-button">Написать</button>
      </div>
    </div>
  </div>
</body>

<!-- <script type="module" src="./index.js"></script> -->
<script>
  "use strict";
  let userName = document.getElementById("name");
  let userText = document.getElementById("text");
  const buttonSent = document.getElementById("button");
  let commentsAll = document.querySelector(".comments");
  let comments = [];

  const updateComments = (newComments) => {
    comments = newComments
  };

  commentsAll.textContent = 'Идет загрузка...';

  const fetchData = () => {
    fetch(`https://wedev-api.sky.pro/api/v1/:sheverdyaeva/comments`)
      .then((reponse) => {
        return reponse.json()
      })
      .then((data) => {
        updateComments(data.comments);
        renderComments();
      });
  };

  fetchData();

  function delay(interval = 300) {
    return new Promise((resolve) => {
      setTimeout(() => {
        resolve();
      }, interval);
    });
  }

  const initLike = () => {
    const buttonElements = document.querySelectorAll(".like-button");

    buttonElements.forEach((buttonElement, id) => {
      buttonElement.addEventListener("click", (event) => {
        event.stopPropagation();
        const commentIndex = parseInt(buttonElement.dataset.id);
        buttonElement.classList.add('-loading-like');

        delay(2000).then(() => {
          comments[commentIndex].isLiked = !comments[commentIndex].isLiked;
          if (comments[commentIndex].isLiked) {
            comments[commentIndex].likes++;
          } else {
            comments[commentIndex].likes--;
          }
          buttonElement.classList.remove('-loading-like');

          renderComments();
        });
      });
    });
  };

  const answerComment = () => {
    const answerElements = document.querySelectorAll("li");

    answerElements.forEach((answerElement, id) => {
      answerElement.addEventListener("click", () => {
        const commentIndex = parseInt(answerElement.dataset.answer);
        userText.value = `${comments[commentIndex].author.name}: ${comments[commentIndex].text}`;
      });
    });
  };

  const renderComments = () => {
    // const buttonElements = document.querySelectorAll(".like-button");
    // commentsAll.innerHTML = comments.map((comment, id) => {
    //   return `<li class="comment" data-id=${id}>
    //       <div class="comment-header">
    //         <div>${comment.author.name}</div>
    //         <div>${comment.date}</div>
    //       </div>
    //       <div class="comment-body">
    //         <div class="comment-text">
    //          ${comment.text}
    //         </div>
    //       </div>
    //       <div class="comment-footer">
    //         <div class="likes">
    //           <span class="likes-counter">${comment.likes}</span>
    //           <button data-id=${id} class="like-button ${comment.isLiked ? '-active-like' : ''}"></button>
    //         </div>
    //       </div>
    //     </li>`
    // }).join("");
    commentsAll.innerHTML = '';

    comments.forEach((user, id) => {
      const li = document.createElement('li');
      li.classList.add('comment');
      li.dataset.answer = id;

      const header = document.createElement('div');
      header.classList.add('comment-header');

      const nameDiv = document.createElement('div');
      nameDiv.textContent = user.author.name;

      const dateDiv = document.createElement('div');
      dateDiv.textContent = user.date;

      header.appendChild(nameDiv);
      header.appendChild(dateDiv);

      const body = document.createElement('div');
      body.classList.add('comment-body');

      const textDiv = document.createElement('div');
      textDiv.classList.add('comment-text');
      textDiv.textContent = user.text;

      body.appendChild(textDiv);

      const footer = document.createElement('div');
      footer.classList.add('comment-footer');

      const likes = document.createElement('div');
      likes.classList.add('likes');

      const counterSpan = document.createElement('span');
      counterSpan.classList.add('likes-counter');
      counterSpan.textContent = user.likes;

      const likeButton = document.createElement('button');
      likeButton.classList.add('like-button');
      likeButton.dataset.id = id;

      if (user.isLiked) {
        likeButton.classList.add('-active-like');
      }
      // (user.isLiked ? 'likeButton.classList.add('-active-like')' : '');

      likes.appendChild(counterSpan);
      likes.appendChild(likeButton);

      footer.appendChild(likes);

      li.appendChild(header);
      li.appendChild(body);
      li.appendChild(footer);

      commentsAll.appendChild(li);
    });

    initLike();
    answerComment();
  };

  buttonSent.addEventListener("click", () => {
    document.querySelector('.add-form-name').style.backgroundColor = 'white';
    document.querySelector('.add-form-text').style.backgroundColor = 'white';

    let dates = new Date();
    let optionsTime = { hour: '2-digit', minute: '2-digit', hour12: false };
    let optionsDate = { day: '2-digit', month: '2-digit', year: '2-digit' };
    let formattedTime = dates.toLocaleString('ru-RU', optionsTime);
    let formattedDate = dates.toLocaleDateString('ru-RU', optionsDate);
    let date = formattedDate + ' ' + formattedTime;

    if (userName.value === "" || userText.value === "") {
      document.querySelector('.add-form-name').style.backgroundColor = 'red';
      document.querySelector('.add-form-text').style.backgroundColor = 'red';

      alert("Заполните все поля");

    } else {
      const newComment = {
        // text: userText.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;"),
        // name: userName.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        name: userName.value,
        date: date,
        text: userText.value,
        likes: 0,
        isLiked: false
      };

      const form = document.querySelector('.add-form');
      form.classList.add('loading');
      const load = document.createElement('div');
      load.textContent = 'Загружаем комментарий...';
      const container = document.querySelector('.container')
      container.appendChild(load);

      fetch(`https://wedev-api.sky.pro/api/v1/:sheverdyaeva/comments`, {
        method: "POST",
        body: JSON.stringify(newComment),
      })
        .then(() => {
          return fetchData();
        })
        .then(() => {
          userName.value = "";
          userText.value = "";
          load.classList.add('loading');
          form.classList.remove('loading');
        })
    }
  });

  console.log("It works!");
</script>

</html>